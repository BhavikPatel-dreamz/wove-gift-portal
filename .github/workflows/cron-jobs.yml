name: Scheduled Cron Jobs

on:
  schedule:
    # Voucher processor - every 5 minutes
    - cron: '*/5 * * * *'
    # Notification processor - every 5 minutes
    - cron: '*/5 * * * *'
    # Scheduled reports - every hour at 15 minutes past
    - cron: '15 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Which job to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - voucher-processor
          - notification-processor
          - scheduled-reports

env:
  VERCEL_URL: ${{ secrets.VERCEL_URL }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}

jobs:
  voucher-processor:
    if: github.event.schedule == '* * * * *' || github.event.inputs.job_type == 'voucher-processor' || github.event.inputs.job_type == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Voucher Processor
        run: |
          curl -f -X POST \
            -H "Authorization: Bearer ${{ env.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ env.VERCEL_URL }}/api/cron/voucher-processor" || exit 1

  notification-processor:
    if: github.event.schedule == '*/5 * * * *' || github.event.inputs.job_type == 'notification-processor' || github.event.inputs.job_type == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Notification Processor
        run: |
          curl -f -X POST \
            -H "Authorization: Bearer ${{ env.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ env.VERCEL_URL }}/api/cron/notification-processor" || exit 1

  scheduled-reports:
    if: github.event.schedule == '15 * * * *' || github.event.inputs.job_type == 'scheduled-reports' || github.event.inputs.job_type == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Scheduled Reports
        run: |
          curl -f -X POST \
            -H "Authorization: Bearer ${{ env.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ env.VERCEL_URL }}/api/cron/scheduled-reports" || exit 1