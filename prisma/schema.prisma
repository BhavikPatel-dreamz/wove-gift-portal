generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id             String           @id @default(cuid())
  email          String           @unique
  phone          String?
  firstName      String
  lastName       String
  password       String
  avatar         String?
  role           UserRole         @default(CUSTOMER)
  isActive       Boolean          @default(false)
  isVerified     Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  accounts       Account[]
  auditLogs      AuditLog[]
  orders         Order[]
  supportRequest SupportRequest[]
  wishlists      Wishlist[]
  sessions       Session[]

  @@map("users")
}

model Account {
  id                        String  @id @default(cuid())
  userId                    String
  type                      String
  provider                  String
  providerAccountId         String
  refresh_token             String? @db.Text
  access_token              String? @db.Text
  expires_at                Int?
  token_type                String?
  scope                     String?
  id_token                  String? @db.Text
  session_state             String?
  oauth_token_secret        String?
  oauth_token               String?
  refresh_token_expires_in  Int?
  user                      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Brand {
  id              String            @id @default(cuid())
  brandName       String            @unique
  currency        String?
  domain          String?           @unique
  slug            String            @unique
  logo            String
  description     String
  website         String
  contact         String
  tagline         String?
  color           String?
  categoryName    String
  isPrimary       Boolean           @default(false)
  isActive        Boolean           @default(false)
  isFeature       Boolean           @default(false)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  brandBankings   BrandBanking?
  brandContacts   BrandContacts[]
  brandTerms      BrandTerms?
  integrations    Integration[]
  orders          Order[]
  ScheduledReport ScheduledReport[]
  settlements     Settlements[]
  vouchers        Vouchers[]
}

model BrandContacts {
  id        String   @id @default(cuid())
  name      String
  role      String
  email     String
  phone     String
  notes     String?
  isPrimary Boolean  @default(false)
  brandId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model BrandTerms {
  id                String           @id @default(cuid())
  settlementTrigger SettlementStatus @default(onRedemption)
  commissionType    CommissionStatus @default(Percentage)
  commissionValue   Float            @default(0)
  maxDiscount       Int?             @default(0)
  minOrderValue     Int?             @default(0)
  currency          String           @default("ZAR")
  breakagePolicy    String?
  breakageShare     Int?             @default(0)
  contractStart     DateTime?
  contractEnd       DateTime?
  goLiveDate        DateTime?
  renewContract     Boolean          @default(false)
  vatRate           Float?           @default(0)
  internalNotes     String?
  brandId           String           @unique
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  brand             Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model BrandBanking {
  id                  String                    @id @default(cuid())
  settlementFrequency SettlementFrequencyStatus @default(monthly)
  dayOfMonth          Int?
  payoutMethod        PayoutMethodStatus        @default(EFT)
  invoiceRequired     Boolean                   @default(false)
  remittanceEmail     String?
  accountHolder       String
  accountNumber       String
  branchCode          String
  bankName            String
  swiftCode           String?
  country             String
  accountVerification Boolean                   @default(false)
  brandId             String                    @unique
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  brand               Brand                     @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

model Integration {
  id             String               @id @default(cuid())
  platform       String?
  storeUrl       String?
  storeName      String?
  apiKey         String?
  apiSecret      String?
  accessToken    String?
  consumerKey    String?
  consumerSecret String?
  isActive       Boolean              @default(true)
  lastSyncAt     DateTime?
  syncStatus     SyncStatus?
  syncMessage    String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  brandId        String
  brand          Brand                @relation(fields: [brandId], references: [id], onDelete: Cascade)
  syncLogs       IntegrationSyncLog[]
}

model IntegrationSyncLog {
  id            String      @id @default(cuid())
  integrationId String
  syncType      String
  status        SyncStatus
  itemsSynced   Int         @default(0)
  errorMessage  String?
  createdAt     DateTime    @default(now())
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
}

model Denomination {
  id          String    @id @default(cuid())
  voucherId   String
  value       Int
  currency    String    @default("ZAR")
  displayName String?
  isExpiry    Boolean
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  voucher     Vouchers  @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@index([voucherId])
  @@index([voucherId, isActive])
  @@map("denominations")
}

model Vouchers {
  id                   String             @id @default(cuid())
  denominationType     DenominationStatus @default(fixed)
  denominationCurrency String             @default("ZAR")
  denominationValue    Int?
  maxAmount            Int?
  minAmount            Int?
  expiresAt            DateTime?
  expiryValue          String?
  graceDays            Int?               @default(0)
  redemptionChannels   Json?
  partialRedemption    Boolean            @default(false)
  stackable            Boolean            @default(false)
  maxUserPerDay        Int?
  termsConditionsURL   String?
  productSku           String?
  isActive             Boolean            @default(true)
  brandId              String
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  isExpiry             Boolean            @default(false)
  expiryPolicy         String?
  voucherCodes         VoucherCode[]
  denominations        Denomination[]
  brand                Brand              @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("vouchers")
}

model VoucherCode {
  id                      String              @id @default(cuid())
  code                    String              @unique
  orderId                 String
  voucherId               String
  shopifyGiftCardId       String?             @unique
  shopifyShop             String?
  shopifySyncError        String?
  shopifySyncedAt         DateTime?
  isRedeemed              Boolean             @default(false)
  redeemedAt              DateTime?
  originalValue           Int
  remainingValue          Int
  expiresAt               DateTime?
  pin                     String?
  qrCode                  String?
  tokenizedLink           String?
  linkExpiresAt           DateTime?
  lastSyncedRedeemedValue String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  bulkRecipient           BulkRecipient?
  order                   Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  giftCard                GiftCard?           @relation(fields: [shopifyGiftCardId], references: [id])
  voucher                 Vouchers            @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  redemptions             VoucherRedemption[]
  deliveryLogs            DeliveryLog[]
  notificationDetails     NotificationDetail[]

  @@index([orderId])
  @@index([voucherId])
}

model VoucherRedemption {
  id             String      @id @default(cuid())
  voucherCodeId  String
  amountRedeemed Int
  balanceAfter   Int
  redeemedAt     DateTime    @default(now())
  transactionId  String?
  storeUrl       String?
  voucherCode    VoucherCode @relation(fields: [voucherCodeId], references: [id], onDelete: Cascade)

  @@unique([transactionId, voucherCodeId, storeUrl])
  @@index([voucherCodeId])
}

model Occasion {
  id                 String             @id @default(cuid())
  name               String             @unique
  emoji              String?
  description        String
  image              String?
  type               String
  isActive           Boolean            @default(true)
  displayOrder       Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  occasionCategories OccasionCategory[]
  orders             Order[]
}

model OccasionCategory {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String
  emoji        String?
  image        String?
  category     String
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  occasionId   String
  occasion     Occasion @relation(fields: [occasionId], references: [id], onDelete: Cascade)
}

model CustomCard {
  id           String   @id @default(dbgenerated("gen_random_uuid()"))
  name         String   @unique
  description  String
  emoji        String?
  image        String?
  category     String
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

model ReceiverDetail {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Order {
  id               String               @id @default(cuid())
  orderNumber      String               @unique
  brandId          String
  occasionId       String
  subCategoryId    String?
  customCardId     String?
  isCustom         Boolean?
  userId           String
  bulkOrderNumber  String?
  receiverDetailId String
  amount           Int
  quantity         Int                  @default(1)
  subtotal         Int
  discount         Int                  @default(0)
  totalAmount      Int
  currency         String               @default("ZAR")
  message          String?
  customImageUrl   String?
  customVideoUrl   String?
  senderName       String?
  senderEmail      String?
  deliveryMethod   DeliveryMethodStatus @default(whatsapp)
  sendType         SendStatus           @default(sendImmediately)
  scheduledFor     DateTime?
  paymentMethod    String?
  paymentStatus    PaymentStatus        @default(PENDING)
  paymentIntentId  String?
  paidAt           DateTime?
  redemptionStatus RedemptionStatus     @default(Issued)
  redeemedAt       DateTime?
  isActive         Boolean              @default(true)
  
  // âœ… NEW FIELDS FOR QUEUE PROCESSING
  isPaid                  Boolean              @default(false)
  voucherEntries          Int                  @default(0)
  vouchersCreated         Int                  @default(0)
  allVouchersGenerated    Boolean              @default(false)
  notificationsSent       Boolean              @default(false)
  processingStatus        OrderProcessingStatus @default(PENDING)
  processingStartedAt     DateTime?
  processingCompletedAt   DateTime?
  lastProcessedAt         DateTime?
  processingErrors        Json?
  retryCount              Int                  @default(0)
  maxRetries              Int                  @default(3)
  
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  
  bulkRecipients   BulkRecipient[]
  brand            Brand                @relation(fields: [brandId], references: [id])
  occasion         Occasion             @relation(fields: [occasionId], references: [id])
  receiverDetail   ReceiverDetail       @relation(fields: [receiverDetailId], references: [id])
  user             User                 @relation(fields: [userId], references: [id])
  voucherCodes     VoucherCode[]
  deliveryLogs     DeliveryLog[]
  notificationDetails NotificationDetail[]

  @@index([userId])
  @@index([brandId])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([isPaid])
  @@index([processingStatus])
  @@index([allVouchersGenerated])
  @@index([notificationsSent])
  @@index([lastProcessedAt])
}


model NotificationDetail {
  id                String              @id @default(cuid())
  orderId           String
  recipientEmail    String?
  recipientPhone    String?
  recipientName     String?
  notificationType  NotificationType    @default(EMAIL)
  status            NotificationStatus  @default(PENDING)
  attemptCount      Int                 @default(0)
  maxRetries        Int                 @default(3)
  sentAt            DateTime?
  deliveredAt       DateTime?
  failedAt          DateTime?
  errorMessage      String?
  messageId         String?
  voucherCodeId     String?
  bulkRecipientId   String?
  
  emailServiceStatus   String?
  emailServiceId       String?
  emailServiceError    String?
  
  whatsappServiceStatus String?
  whatsappServiceId     String?
  whatsappServiceError  String?
  
  smsServiceStatus     String?
  smsServiceId         String?
  smsServiceError      String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  order             Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  voucherCode       VoucherCode?        @relation(fields: [voucherCodeId], references: [id])
  bulkRecipient     BulkRecipient?      @relation(fields: [bulkRecipientId], references: [id])
  
  @@index([orderId])
  @@index([status])
  @@index([notificationType])
  @@index([sentAt])
  @@index([voucherCodeId])
  @@index([bulkRecipientId])
  @@map("notification_details")
}


model DeliveryLog {
  id                       String               @id @default(cuid())
  orderId                  String
  voucherCodeId            String?
  method                   DeliveryMethodStatus
  recipient                String
  status                   DeliveryStatus       @default(PENDING)
  attemptCount             Int                  @default(0)
  sentAt                   DateTime?
  deliveredAt              DateTime?
  errorMessage             String?
  messageId                String?
  giftCardCreated          Boolean              @default(false)
  giftCardCreatedAt        DateTime?
  giftCardShopifyId        String?              @unique
  giftCardError            String?
  paymentStatus            PaymentStatus        @default(PENDING)
  paymentUpdatedAt         DateTime?
  voucherGenerated         Boolean              @default(false)
  voucherGeneratedAt       DateTime?
  voucherGenerationError   String?
  shopifySyncStatus        SyncStatus?
  shopifySyncedAt          DateTime?
  shopifySyncError         String?
  emailServiceStatus       String?
  emailServiceId           String?
  emailServiceError        String?
  smsServiceStatus         String?
  smsServiceId             String?
  smsServiceError          String?
  whatsappServiceStatus    String?
  whatsappServiceId        String?
  whatsappServiceError     String?
  lastRetryAt              DateTime?
  maxRetries               Int                  @default(3)
  processingTimeMs         Int?
  deliveryLatencyMs        Int?
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  gift_card_created        Boolean              @default(false)
  gift_card_created_at     DateTime?            @db.Timestamp(6)
  gift_card_shopify_id     String?              @unique
  gift_card_error          String?
  payment_status           String               @default("PENDING")
  payment_updated_at       DateTime?            @db.Timestamp(6)
  voucher_generated        Boolean              @default(false)
  voucher_generated_at     DateTime?            @db.Timestamp(6)
  voucher_generation_error String?
  shopify_sync_status      String?
  shopify_synced_at        DateTime?            @db.Timestamp(6)
  shopify_sync_error       String?
  email_service_status     String?
  email_service_id         String?
  email_service_error      String?
  sms_service_status       String?
  sms_service_id           String?
  sms_service_error        String?
  whatsapp_service_status  String?
  whatsapp_service_id      String?
  whatsapp_service_error   String?
  last_retry_at            DateTime?            @db.Timestamp(6)
  max_retries              Int                  @default(3)
  processing_time_ms       Int?
  delivery_latency_ms      Int?
  order                    Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  voucherCode              VoucherCode?         @relation(fields: [voucherCodeId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([voucherCodeId])
  @@index([status])
  @@index([giftCardCreated])
  @@index([paymentStatus])
  @@index([shopifySyncStatus])
  @@index([emailServiceStatus])
  @@index([sentAt])
  @@index([deliveredAt])
  @@index([email_service_status], map: "idx_delivery_logs_email_service_status")
  @@index([gift_card_created], map: "idx_delivery_logs_gift_card_created")
  @@index([payment_status], map: "idx_delivery_logs_payment_status")
  @@index([shopify_sync_status], map: "idx_delivery_logs_shopify_sync_status")
  @@map("delivery_logs")
}

model Settlements {
  id                String                  @id @default(cuid())
  brandId           String
  settlementPeriod  String
  periodStart       DateTime
  periodEnd         DateTime
  totalSold         Int
  totalSoldAmount   Int
  totalRedeemed     Int
  redeemedAmount    Int
  outstanding       Int
  outstandingAmount Int
  commissionAmount  Int
  breakageAmount    Int?
  vatAmount         Int?
  netPayable        Int
  totalPaid         Int?                    @default(0)
  remainingAmount   Int?                    @default(0)
  status            SettlementPaymentStatus @default(Pending)
  paidAt            DateTime?
  lastPaymentDate   DateTime?
  paymentCount      Int?                    @default(0)
  paymentHistory    Json?
  paymentReference  String?
  notes             String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  brand             Brand                   @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([status])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  brandId   String?
  voucherId String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, voucherId])
  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userEmail String?
  action    String
  entity    String
  entityId  String?
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model ScheduledReport {
  id               String                @id @default(cuid())
  shop             String?
  brandId          String?
  frequency        String
  deliveryDay      String
  deliveryMonth    String?
  deliveryYear     String?
  emailRecipients  String
  reportTypes      Json
  nextDeliveryDate DateTime
  lastDeliveryDate DateTime?
  status           ScheduledReportStatus @default(Active)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  brand            Brand?                @relation(fields: [brandId], references: [id])

  @@index([shop])
  @@index([brandId])
  @@index([status])
  @@index([nextDeliveryDate])
}

model ShopifySession {
  id          String    @id @default(cuid())
  shop        String    @unique
  accessToken String
  scope       String?
  isOnline    Boolean   @default(false)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model AppInstallation {
  id          String   @id @default(cuid())
  shop        String   @unique
  accessToken String
  scopes      String
  installedAt DateTime @default(now())
  isActive    Boolean  @default(true)
}

model GiftCard {
  id             String       @id @default(cuid())
  shop           String
  shopifyId      String?      @unique
  code           String       @unique
  initialValue   Float
  balance        Float
  customerEmail  String?
  note           String?
  expiresAt      DateTime?
  isActive       Boolean      @default(true)
  isVirtual      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  denominationId String?
  voucherCode    VoucherCode?

  @@index([shop])
  @@index([code])
  @@index([customerEmail])
  @@index([denominationId])
}

model SupportRequest {
  id          String           @id @default(cuid())
  supportId   String           @unique
  name        String
  email       String
  phone       String?
  orderNumber String?
  reason      String
  message     String?
  status      SupportStatus    @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  userId      String
  messages    SupportMessage[]
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([email])
}

model SupportMessage {
  id               String         @id @default(cuid())
  supportRequestId String
  senderType       SenderType
  senderName       String
  senderEmail      String?
  message          String
  attachments      String[]       @default([])
  isRead           Boolean        @default(false)
  createdAt        DateTime       @default(now())
  supportRequest   SupportRequest @relation(fields: [supportRequestId], references: [id], onDelete: Cascade)

  @@index([supportRequestId])
  @@index([createdAt])
}

model BulkRecipient {
  id               String       @id @default(cuid())
  orderId          String
  voucherCodeId    String?      @unique
  recipientName    String
  recipientEmail   String
  recipientPhone   String?
  personalMessage  String?
  emailSent        Boolean      @default(false)
  emailSentAt      DateTime?
  emailDelivered   Boolean      @default(false)
  emailDeliveredAt DateTime?
  emailError       String?
  rowNumber        Int
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  voucherCode      VoucherCode? @relation(fields: [voucherCodeId], references: [id])
  notificationDetails NotificationDetail[]

  @@index([orderId])
  @@index([recipientEmail])
  @@index([emailSent])
  @@index([voucherCodeId])
}

enum UserRole {
  CUSTOMER
  ADMIN
  BRAND_MANAGER
  SUPPORT
  FINANCE
}

enum SettlementStatus {
  onRedemption
  onPurchase
}

enum CommissionStatus {
  Fixed
  Percentage
}

enum PolicyStatus {
  Retain
  Share
}

enum DenominationStatus {
  fixed
  both
  amount
}

enum IntegrationType {
  shopify
  woocommerce
  magento
  custom_api
  other
}

enum SyncStatus {
  success
  failed
  partial
  syncing
  pending
}

enum PayoutMethodStatus {
  EFT
  wire_transfer
  paypal
  stripe
  manual
}

enum SettlementFrequencyStatus {
  daily
  weekly
  monthly
  quarterly
}

enum DeliveryMethodStatus {
  whatsapp
  email
  sms
  print
  multiple
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum RedemptionStatus {
  Issued
  PartiallyRedeemed
  Redeemed
  Expired
  Cancelled
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum SendStatus {
  sendImmediately
  scheduleLater
}

enum SettlementPaymentStatus {
  Pending
  Paid
  Partial
  InReview
  Disputed
}

enum ScheduledReportStatus {
  Active
  Paused
  Cancelled
}

enum SupportStatus {
  PENDING
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SenderType {
  CUSTOMER
  ADMIN
}

enum EmailServiceStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

enum SMSServiceStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
}

enum WhatsAppServiceStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}


enum OrderProcessingStatus {
  PENDING
  PAYMENT_CONFIRMED
  VOUCHERS_CREATING
  VOUCHERS_CREATED
  NOTIFICATIONS_SENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum NotificationType {
  EMAIL
  WHATSAPP
  SMS
  BULK_EMAIL
  SUMMARY_EMAIL
}

enum NotificationStatus {
  PENDING
  QUEUED
  SENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  CANCELLED
}
